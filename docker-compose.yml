services:
  app:
    build: .
    image: image-preference-optimizer:latest
    user: "1000:1000"
    # ports not needed with network_mode: host
    environment:
      - FLUX_LOCAL_MODEL=${FLUX_LOCAL_MODEL:-stabilityai/sd-turbo}
      - HUGGINGFACE_HUB_TOKEN
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    volumes:
      - .:/app
      - hf_cache:/root/.cache/huggingface
      - /var/run/postgresql:/var/run/postgresql
    network_mode: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped

  tests-smoke:
    build: .
    image: image-preference-optimizer:latest
    command: ["bash", "scripts/run_tests.sh", "smoke"]
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - .:/app
    profiles: ["test"]

  gen:
    build: .
    image: image-preference-optimizer:latest
    command: ["python", "scripts/generate_and_inspect.py"]
    environment:
      - FLUX_LOCAL_MODEL=${FLUX_LOCAL_MODEL:-stabilityai/sd-turbo}
    volumes:
      - .:/app
      - hf_cache:/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    profiles: ["gen"]

  gen-server:
    build:
      context: .
      dockerfile: Dockerfile.server
    image: gen-server:latest
    ports:
      - "8580:8580"
    environment:
      - GEN_SERVER_MODEL=${GEN_SERVER_MODEL:-stabilityai/sd-turbo}
      - HUGGINGFACE_HUB_TOKEN
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    volumes:
      - hf_cache:/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8580/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    profiles: ["server"]
    restart: unless-stopped

volumes:
  hf_cache:
